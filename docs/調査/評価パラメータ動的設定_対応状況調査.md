# 調査結果: 07_評価ロジック.md の評価パラメータ動的設定対応状況

**調査日**: 2026-02-07
**対象**: 設計書 `07_評価ロジック.md` で定義されている評価パラメータの動的変更対応状況

## Context

設計書 `07_評価ロジック.md` で定義されている評価パラメータが、PoC実装上で外部から動的に変更できるようになっているかの調査。
PoC環境では JSONファイル + Next.js API Routes + 管理画面UI の構成で設定管理基盤を構築済み。

## 結論

**全パラメータが動的変更に対応済み。** 具体的には以下の3層で対応している:

1. **管理画面UI** (`/admin/config`) — 3タブ（JLPT・スコア・弱点分析）で全パラメータを編集可能
2. **API + JSONストレージ** — 変更がJSONファイルに永続化され、変更履歴も記録
3. **サービス/フック層** — 全関数が `config?` オプション引数を受け取り、未指定時はデフォルト値にフォールバック

## 実装アーキテクチャ

```
管理画面UI (/admin/config)
    ↓ fetch
configService.ts
    ↓ /api/config, /api/admin/config/[key]
Next.js API Routes
    ↓ fs/promises
lib/data/evaluationConfig.ts
    ↓ readFile / writeFile
backend/app/data/seed/evaluation_config.json
```

### ファイル構成

| レイヤー | ファイル | 役割 |
|---------|---------|------|
| 型定義 | `poc/src/types/evaluationConfig.ts` | JLPTConfig, ScoringConfig, WeakPointConfig 等の型 |
| デフォルト値 | `poc/src/data/defaultEvaluationConfig.ts` | API取得失敗時のフォールバック値 |
| データストア | `backend/app/data/seed/evaluation_config.json` | 3キー分の設定値 + 変更履歴 |
| データアクセス | `poc/src/lib/data/evaluationConfig.ts` | fs/promises による CRUD |
| API (公開) | `poc/src/app/api/config/route.ts` | GET 全設定取得 |
| API (管理者) | `poc/src/app/api/admin/config/[key]/route.ts` | GET/PUT 個別設定 |
| API (履歴) | `poc/src/app/api/admin/config/[key]/history/route.ts` | GET 変更履歴 |
| サービス | `poc/src/services/configService.ts` | フロントエンドからのAPI呼び出し |
| フック | `poc/src/hooks/useEvaluationConfig.ts` | Reactコンポーネント向け設定取得 |
| 管理画面 | `poc/src/app/admin/config/page.tsx` | タブUIで3種の設定を編集 |
| UIコンポーネント | `poc/src/components/admin/config/JLPTConfigForm.tsx` | JLPT設定フォーム |
| UIコンポーネント | `poc/src/components/admin/config/ScoringConfigForm.tsx` | スコア設定フォーム |
| UIコンポーネント | `poc/src/components/admin/config/WeakPointConfigForm.tsx` | 弱点分析設定フォーム |
| UIコンポーネント | `poc/src/components/admin/config/ConfigHistoryPanel.tsx` | 変更履歴パネル |

## パラメータ別対応状況

### 設計書 7.3: JLPTレベル別重み付け

| パラメータ | 設計書の値 | 動的対応 | 使用ファイル |
|-----------|-----------|---------|------------|
| N1 語彙:0.20 文法:0.20 内容:0.25 敬語:0.35 | 7.3節 | 対応済 | `evaluationService.ts` `calculateTotalScore(scores, level, jlptConfig?)` |
| N2〜N5 各重み | 7.3節 | 対応済 | 同上 |
| estimationRanges (N1:80〜N5:40) | 7.9.5節 | 対応済 | `useAdaptiveLevel.ts` `estimateLevelFromScore(score, jlptConfig?)` |
| speechRate / useSimplified / followUpDepth | — | 対応済 | 管理画面で編集可能（利用側は未実装） |

### 設計書 7.5: 苦手分析パラメータ

| パラメータ | 設計書の値 | 動的対応 | 使用ファイル |
|-----------|-----------|---------|------------|
| 苦手検出閾値 | 70点 | 対応済 | `evaluationService.ts` `detectWeakPoints(scores, feedback, weakPointConfig?)` |
| 同上 | 70点 | 対応済 | `weakPointService.ts` `detectWeakPointCandidates(scores, config?)` |
| タグ登録閾値 (累計3回) | 3回 | 対応済 | `weakPointService.ts` `shouldRegisterAsTag()` |
| 解消条件 (連続3回/80点以上) | 3回, 80点 | 対応済 | `weakPointService.ts` `updateWeakPoints(existing, scores, userId, config?)` |
| 優先度: occurrenceMultiplier | 10 | 対応済 | `weakPointService.ts` `calculatePriorityScore(count, date, config?)` |
| 優先度: recencyWindowDays | 30 | 対応済 | 同上 |
| 優先度: highThreshold | 50 | 対応済 | `weakPointService.ts` `determinePriorityLevel(score, config?)` |
| 優先度: mediumThreshold | 25 | 対応済 | 同上 |

### 設計書 7.10: 適応型レベル調整

| パラメータ | 設計書の値 | 動的対応 | 使用ファイル |
|-----------|-----------|---------|------------|
| レベルUP閾値 | 70点以上 | 対応済 | `useAdaptiveLevel.ts` `calculateNextLevel(level, score, scoringConfig?)` |
| レベルDOWN閾値 | 30点以下 | 対応済 | 同上 |
| dailyChallengeLimit | 3回 | 対応済 | `useAdaptiveLevel.ts` (モジュール定数、関数引数未対応) |

### 設計書 7.11: 企業向け統合評価

| パラメータ | 設計書の値 | 動的対応 | 使用ファイル |
|-----------|-----------|---------|------------|
| gradeThresholds (S:90〜D:0) | 7.7.2節相当 | 対応済 | 管理画面で編集可能 |
| performanceGrades (excellent:90, good:80, pass:70) | — | 対応済 | `useAdaptiveLevel.ts` `calculatePerformanceGrade(score, scoringConfig?)` |
| jobSuitability (4業務タイプ x requiredLevel + minScore) | 7.11.3節 | 対応済 | `useAdaptiveLevel.ts` `calculateJobSuitability(perfs, scoringConfig?)` |

## 実装パターン（全関数共通）

```typescript
// パターン: オプショナル引数 + デフォルトフォールバック
export function calculateTotalScore(
  scores: CategoryScores,
  jlptLevel: JLPTLevel,
  jlptConfig?: JLPTConfig          // 外部からconfigを渡せる
): number {
  const weightsMap = jlptConfig     // 渡された場合はそれを使用
    ? jlptConfig.weights
    : JLPT_LEVEL_WEIGHTS;           // 未指定時はデフォルト
  // ...
}
```

このパターンにより:
- 既存コードとの後方互換性を維持
- configを渡さない場合はデフォルト値で動作
- 管理画面から変更したconfigを渡せば動的に挙動が変わる

## 設定JSONファイルの構造

`backend/app/data/seed/evaluation_config.json` に3キー分の設定が格納:

```json
{
  "configs": [
    { "config_key": "jlpt_config", "config_value": { ... }, "version": 1 },
    { "config_key": "scoring_config", "config_value": { ... }, "version": 1 },
    { "config_key": "weak_point_config", "config_value": { ... }, "version": 1 }
  ],
  "history": []
}
```

設定更新時には `history` 配列に変更前後のJSON + バージョン番号が自動記録される。

## バリデーション

管理画面の各フォームにはバリデーションが実装済み:

- **JLPTConfigForm**: 各レベルの重みの合計が1.0であること、推定レンジがN1 > N2 > ... > N5の降順
- **ScoringConfigForm**: グレード閾値が降順、パフォーマンスグレードが excellent > good > pass、レベル上昇閾値 > 下降閾値
- **WeakPointConfigForm**: 解消スコア > 検出閾値、高優先度閾値 > 中優先度閾値

## 注意点: まだ「配線」が完了していない箇所

サービス関数はconfig引数を受け取れるが、**呼び出し元がconfigを渡しているか**は別問題。現時点では:

- **管理画面からの設定変更** → JSONファイルに保存 → API経由で取得可能
- **useEvaluationConfig フック** → API経由でconfigを取得しコンポーネントに提供
- **実際の面接評価実行時** → `evaluationService.ts` の `formatEvaluationResult()` 等がconfigを渡して呼び出すかどうかは、面接セッション機能の実装状況次第

つまり「技術的に動的変更可能な状態」にはなっているが、全ての呼び出しパスでconfigが注入されているかの最終確認は、面接セッション機能の結合時に行う必要がある。

## ビルド検証

```
cd poc && npm run build
```

結果: エラーなし。全ルートが正常に生成されている。

```
Route (app)                              Size     First Load JS
├ ○ /admin/config                        5.92 kB        93.3 kB
├ ƒ /api/admin/config/[key]              0 B                0 B
├ ƒ /api/admin/config/[key]/history      0 B                0 B
├ ○ /api/config                          0 B                0 B
```
