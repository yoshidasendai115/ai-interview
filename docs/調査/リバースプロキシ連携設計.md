# 16. リバースプロキシ連携設計

## 16.1 概要

### 16.1.1 背景

本システム（AI面接練習）は、既存システム「mintoku work」（`https://cloud.maetore.tech`）からの遷移で利用される。独自ドメインを取得せず、リバースプロキシを使用してパスベースでルーティングする。

### 16.1.2 要件

| 項目 | 内容 |
|------|------|
| 既存システムURL | `https://cloud.maetore.tech` |
| AI面接システムへのアクセスパス | `/ai-interview` |
| ドメイン取得 | なし（リバースプロキシで対応） |

---

## 16.2 リバースプロキシとは

### 16.2.1 基本概念

リバースプロキシは「中継サーバー」として機能し、クライアントからのリクエストを適切なバックエンドサーバーに振り分ける。

```
【通常のアクセス（独自ドメインあり）】
ユーザー → https://ai-interview.example.com → AI面接システム

【リバースプロキシ経由（本構成）】
ユーザー → https://cloud.maetore.tech/ai-interview → リバースプロキシ → AI面接システム
```

### 16.2.2 リバースプロキシの役割

| 役割 | 説明 |
|------|------|
| **URLルーティング** | パスに応じて適切なバックエンドに転送 |
| **SSL終端** | HTTPS通信の暗号化/復号をプロキシで処理 |
| **ロードバランシング** | 複数サーバーへの負荷分散 |
| **キャッシュ** | 静的ファイルのキャッシュ |
| **セキュリティ** | バックエンドサーバーを外部から隠蔽 |

---

## 16.3 システム構成

### 16.3.1 現在のAI面接システム構成

```
CloudFront (CDN)
    ├─ / → S3 (静的ファイル)
    └─ /api/* → ALB → EC2 (ポート8000)
```

### 16.3.2 リバースプロキシ連携後の構成

```
ユーザー
    ↓
https://cloud.maetore.tech
    ↓
mintoku workのリバースプロキシ（Nginx）
    ├─ /ai-interview/* → AI面接システム（CloudFront）
    └─ その他 → mintoku work本体
```

### 16.3.3 リクエストフロー

```
1. ユーザーが https://cloud.maetore.tech/ai-interview にアクセス
    ↓
2. mintoku workのNginxがリクエストを受信
    ↓
3. パスが /ai-interview/* に一致
    ↓
4. AI面接システムのCloudFrontに転送
   （パスから /ai-interview を除去）
    ↓
5. CloudFrontがS3またはALBにルーティング
    ↓
6. レスポンスをユーザーに返却
```

---

## 16.4 実装パターン

### 16.4.1 パターンA: CloudFront経由（推奨）

```
cloud.maetore.tech/ai-interview/*
    ↓ (リバースプロキシ)
AI面接システムのCloudFront
    ↓
S3 or ALB
```

**メリット**:
- CDNキャッシュを活用できる
- WAF/セキュリティ設定が有効
- 高速なレスポンス

**デメリット**:
- CloudFrontのドメイン設定が必要

### 16.4.2 パターンB: ALB直接接続

```
cloud.maetore.tech/ai-interview/*
    ↓ (リバースプロキシ)
AI面接システムのALB
    ↓
EC2
```

**メリット**:
- シンプルな構成
- CloudFrontのドメイン設定不要

**デメリット**:
- CDNキャッシュなし
- ALBを公開する必要あり

---

## 16.5 技術的な考慮事項

### 16.5.1 パスの書き換え

リバースプロキシでパスの書き換えが必要。

| リクエストURL | 転送先URL |
|---------------|-----------|
| `/ai-interview/` | `/` |
| `/ai-interview/api/v1/health` | `/api/v1/health` |
| `/ai-interview/_next/static/...` | `/_next/static/...` |

### 16.5.2 Next.js basePath設定

AI面接システム側でNext.jsの`basePath`設定が必要。

```javascript
// next.config.js
module.exports = {
  basePath: '/ai-interview',
  assetPrefix: '/ai-interview',
}
```

これにより:
- 内部リンクが自動的に `/ai-interview` プレフィックス付きで生成される
- 静的ファイルのパスも正しく解決される

### 16.5.3 WebSocket対応（重要）

HeyGenのStreaming Avatarは**WebSocket**を使用する。リバースプロキシでWebSocketをサポートする必要がある。

```nginx
# WebSocket用の追加設定
proxy_http_version 1.1;
proxy_set_header Upgrade $http_upgrade;
proxy_set_header Connection "upgrade";
proxy_read_timeout 86400;  # 長時間接続対応（24時間）
```

**注意**: WebSocket対応がないとHeyGen Avatarが動作しない。

### 16.5.4 CORS設定

異なるオリジン間の通信のため、AI面接システム側でCORS設定が必要。

```typescript
// API側のCORS設定
{
  "Access-Control-Allow-Origin": "https://cloud.maetore.tech",
  "Access-Control-Allow-Credentials": "true",
  "Access-Control-Allow-Methods": "GET, POST, PUT, DELETE, OPTIONS",
  "Access-Control-Allow-Headers": "Content-Type, Authorization"
}
```

### 16.5.5 Cookie/セッション

| 設定項目 | 推奨値 | 理由 |
|----------|--------|------|
| Domain | `.maetore.tech` | サブドメイン間で共有可能 |
| SameSite | `Lax` または `None` | クロスサイトリクエスト対応 |
| Secure | `true` | HTTPS必須 |

---

## 16.6 Nginx設定例

### 16.6.1 mintoku work側のNginx設定

```nginx
server {
    listen 443 ssl;
    server_name cloud.maetore.tech;

    # SSL設定（既存）
    ssl_certificate /path/to/cert.pem;
    ssl_certificate_key /path/to/key.pem;

    # AI面接システムへのリバースプロキシ
    location /ai-interview/ {
        # CloudFrontへ転送（パス書き換え）
        proxy_pass https://d1234567890.cloudfront.net/;

        # ヘッダー設定
        proxy_set_header Host d1234567890.cloudfront.net;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;

        # WebSocket対応（HeyGen用）
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_read_timeout 86400;
        proxy_send_timeout 86400;

        # バッファ設定
        proxy_buffering off;
        proxy_cache off;
    }

    # mintoku work本体（既存）
    location / {
        # 既存の設定
    }
}
```

### 16.6.2 設定のポイント

| 設定 | 説明 |
|------|------|
| `proxy_pass` の末尾スラッシュ | パス書き換えに必要 |
| `Host` ヘッダー | CloudFrontのドメインを指定 |
| `proxy_http_version 1.1` | WebSocket対応に必須 |
| `Upgrade` / `Connection` | WebSocketハンドシェイク用 |
| `proxy_read_timeout` | 長時間接続対応 |

---

## 16.7 必要な作業一覧

### 16.7.1 mintoku work側（外部チーム）

| No | 作業 | 詳細 | 優先度 |
|----|------|------|--------|
| 1 | Nginx設定追加 | `/ai-interview/*` のリバースプロキシ設定 | 必須 |
| 2 | WebSocket対応 | Upgrade/Connectionヘッダーの転送設定 | 必須 |
| 3 | 動作確認 | 転送・WebSocketの疎通確認 | 必須 |

### 16.7.2 AI面接システム側（本チーム）

| No | 作業 | 詳細 | 優先度 |
|----|------|------|--------|
| 1 | Next.js basePath設定 | `next.config.js` に `/ai-interview` 設定 | 必須 |
| 2 | CORS設定 | `cloud.maetore.tech` を許可オリジンに追加 | 必須 |
| 3 | 環境変数調整 | 公開URLを `https://cloud.maetore.tech/ai-interview` に変更 | 必須 |
| 4 | 内部リンク確認 | 全てのリンクが正しく動作するか確認 | 必須 |
| 5 | HeyGen動作確認 | WebSocket経由でAvatar接続できるか確認 | 必須 |

---

## 16.8 代替案

### 16.8.1 代替案1: サブドメイン使用

```
https://ai-interview.maetore.tech
```

| 項目 | 内容 |
|------|------|
| メリット | リバースプロキシ不要、シンプルな構成 |
| デメリット | DNS設定、SSL証明書の追加が必要 |
| 作業 | DNSにAレコード追加、ACM証明書発行 |

### 16.8.2 代替案2: iframe埋め込み

```html
<iframe src="https://ai-interview-internal.example.com" />
```

| 項目 | 内容 |
|------|------|
| メリット | 最も簡単、設定変更が少ない |
| デメリット | セキュリティ制約、UX悪化、WebSocket問題 |
| 推奨 | **非推奨** |

---

## 16.9 テスト項目

### 16.9.1 機能テスト

| No | テスト項目 | 期待結果 |
|----|-----------|----------|
| 1 | トップページアクセス | `/ai-interview/` でホーム画面表示 |
| 2 | 静的ファイル読み込み | CSS/JS/画像が正しく読み込まれる |
| 3 | API呼び出し | `/ai-interview/api/*` が正しく動作 |
| 4 | HeyGen Avatar接続 | WebSocket接続が確立、Avatar表示 |
| 5 | 音声認識 | マイク入力→テキスト変換が動作 |
| 6 | セッション維持 | ログイン状態が維持される |

### 16.9.2 非機能テスト

| No | テスト項目 | 期待結果 |
|----|-----------|----------|
| 1 | レスポンス時間 | 初回ロード3秒以内 |
| 2 | WebSocket安定性 | 30分以上の接続維持 |
| 3 | エラーハンドリング | プロキシ障害時の適切なエラー表示 |

---

## 16.10 リスクと対策

| リスク | 影響 | 対策 |
|--------|------|------|
| WebSocket非対応 | HeyGen Avatar動作不可 | 事前にNginx設定確認、テスト環境で検証 |
| パス書き換えミス | 404エラー多発 | 設定レビュー、段階的リリース |
| CORS設定漏れ | API呼び出し失敗 | 開発環境で事前検証 |
| Cookie問題 | ログイン状態維持不可 | SameSite/Domain属性の適切な設定 |

---

## 16.11 更新履歴

| 日付 | バージョン | 変更内容 |
|------|----------|---------|
| 2026-02-01 | 1.0.0 | 初版作成 |
