# 7. JLPTレベル別評価ロジック（日本語能力評価）

## 7.0 本設計書の位置づけ

### 7.0.1 評価体系の全体像

本システムでは、面接評価を以下の2つの評価軸で実施する:

| 評価種別 | 設計書 | 評価対象 | スコア範囲 | 評価タイミング |
|---------|--------|---------|----------|--------------|
| **日本語能力評価** | 本設計書（07） | 語彙・文法・内容・敬語 | 0-100点 | 各回答ごとにGPT-4oで自動評価 |
| **採用適性評価** | 13_面接シナリオ設計 | 適応力・コミュニケーション力・主体性・定着意向・協調性 | 1-5点 | セッション終了後に総合評価 |

### 7.0.2 本設計書の役割

本設計書は「**日本語能力評価**」を定義する。具体的には:
- 外国人求職者の日本語運用能力をGPT-4oで自動評価
- JLPTレベル別の評価基準・重み付けを設定
- 苦手項目（語彙・文法・内容・敬語）の検出・蓄積ロジック

採用適性評価については13_面接シナリオ設計を参照。

---

## 7.1 評価基準

| レベル | 評価の重点項目 | AIによる主なチェック項目                             |
| ------ | -------------- | ---------------------------------------------------- |
| N1/N2  | ビジネス即戦力 | 尊敬・謙譲語の使い分け、論理的思考、逆質問の妥当性   |
| N3     | 実務・接客対応 | 丁寧語（です・ます）の維持、質問の意図解釈、定型表現 |
| N4/N5  | 基本意思疎通   | 基本挨拶、語順の正しさ、聞き取りの可否               |

## 7.2 評価カテゴリと配点

| カテゴリ | 英語名 | 配点比率 | 説明 |
|---------|--------|----------|------|
| 語彙 | vocabulary | 25% | 適切な語彙の選択、語彙の豊富さ |
| 文法 | grammar | 25% | 文法の正確性、文構造の適切さ |
| 内容 | content | 25% | 回答の論理性、質問への適切な応答 |
| 敬語 | honorifics | 25% | 敬語の正確な使用、場面に応じた使い分け |

## 7.3 スコアリング計算式

### 総合スコア計算

```
総合スコア = (語彙スコア × 0.25) + (文法スコア × 0.25) + (内容スコア × 0.25) + (敬語スコア × 0.25)
```

### JLPTレベル別重み付け

| レベル | 語彙 | 文法 | 内容 | 敬語 |
|--------|------|------|------|------|
| N1 | 0.20 | 0.20 | 0.25 | 0.35 |
| N2 | 0.20 | 0.25 | 0.25 | 0.30 |
| N3 | 0.25 | 0.30 | 0.25 | 0.20 |
| N4 | 0.30 | 0.35 | 0.25 | 0.10 |
| N5 | 0.35 | 0.40 | 0.20 | 0.05 |

## 7.4 GPT-4o評価プロンプト

### システムプロンプト

```
あなたは日本語能力試験（JLPT）の評価専門家です。
外国人求職者の面接練習における回答を評価し、改善点を具体的にフィードバックします。

評価対象者のJLPTレベル: {jlpt_level}
評価基準:
1. 語彙（vocabulary）: 適切な語彙選択、語彙の豊富さ、専門用語の使用
2. 文法（grammar）: 文法の正確性、文構造、接続表現の適切さ
3. 内容（content）: 質問への適切な応答、論理性、具体例の使用
4. 敬語（honorifics）: 尊敬語・謙譲語・丁寧語の正確な使い分け

出力形式はJSON形式で、以下の構造に従ってください。
```

### ユーザープロンプト（回答評価時）

```
以下の面接質問に対する回答を評価してください。

【質問】
{question_text}

【回答】
{answer_text}

【評価基準】
{evaluation_criteria}

以下のJSON形式で回答してください:
{
  "scores": {
    "vocabulary": <0-100の整数>,
    "grammar": <0-100の整数>,
    "content": <0-100の整数>,
    "honorifics": <0-100の整数>
  },
  "feedback": {
    "vocabulary": "<具体的なフィードバック>",
    "grammar": "<具体的なフィードバック>",
    "content": "<具体的なフィードバック>",
    "honorifics": "<具体的なフィードバック>"
  },
  "weak_points": [
    {
      "category": "<カテゴリ>",
      "description": "<問題点の説明>",
      "example": "<具体例>",
      "suggestion": "<改善提案>"
    }
  ],
  "overall_feedback": "<全体的な総評>"
}
```

## 7.5 苦手分析の仕組み

### 苦手項目検出アルゴリズム

1. **解析**: 音声データをGoogle STTでテキスト化し、GPT-4oが4指標でスコアリング
2. **検出**: スコアが閾値（70点）未満のカテゴリを苦手候補として抽出
3. **蓄積**: 同一カテゴリの苦手が3回以上発生した場合、苦手タグとしてDBに記録
4. **優先度計算**: 発生頻度と直近発生日から優先度を算出
5. **最適化**: 次回セッション開始時、苦手タグに関連する質問やアドバイスをAIが優先的に選定

### 優先度計算式

```
優先度スコア = (発生回数 × 10) + (30 - 最終発生からの日数)

優先度判定:
- high: 優先度スコア >= 50
- medium: 優先度スコア >= 25
- low: 優先度スコア < 25
```

### 苦手項目の解消条件

- 同一カテゴリで3回連続80点以上を取得
- 解消後は `resolved = true` に更新

## 7.6 評価フロー

```
1. 面接セッション完了
   ↓
2. 各回答のテキストを収集
   ↓
3. GPT-4oに評価リクエスト（バッチ処理）
   ↓
4. 各回答のスコア・フィードバックを取得
   ↓
5. セッション全体の総合スコアを計算
   ↓
6. 苦手項目を検出・更新
   ↓
7. 評価結果をDB保存（evaluation_details テーブル）
   ↓
8. 採用適性評価と統合してmintoku workへ結果送信
```

## 7.7 採用適性評価との統合

### 7.7.1 統合評価の構成

セッション完了時、日本語能力評価と採用適性評価を統合した総合評価を生成する。

![統合評価の構成](../images/評価_統合評価構成図.png)

### 7.7.2 統合スコアの計算方法

```
総合スコア（100点満点）= (日本語能力スコア × 0.4) + (採用適性スコア × 20 × 0.6)

※採用適性スコア（1-5点）を100点満点に換算して統合
```

### 7.7.3 DBテーブルの対応

| 評価種別 | 保存先テーブル | カテゴリ値 |
|---------|--------------|----------|
| 日本語能力評価 | evaluation_details | vocabulary, grammar, content, honorifics |
| 採用適性評価 | aptitude_evaluations | adaptability, communication, initiative, retention, cooperation |

### 7.7.4 mintoku workへの送信データ

両評価を統合したデータをmintoku workに送信する。詳細は10_API仕様 10.6節を参照。

---

## 7.8 関連設計書

| 設計書 | 関連内容 |
|--------|---------|
| 10_API仕様 | 評価APIレスポンス形式、mintoku work連携API |
| 11_データベーススキーマ | evaluation_details, aptitude_evaluationsテーブル |
| 12_面接フロー制御 | セッション完了時の評価処理フロー |
| 13_面接シナリオ設計 | 採用適性評価の詳細定義 |

---

## 7.9 JLPTレベル乖離検出

### 7.9.1 目的

申告されたJLPTレベルと実際の面接評価スコアを比較し、能力の乖離を検出する。
これにより、採用担当者が適切な判断を行えるよう支援する。

### 7.9.2 期待スコア閾値

| 申告レベル | 期待最低スコア | 乖離判定閾値 | 推定レベル判定 |
|-----------|---------------|-------------|---------------|
| N1 | 80点 | < 70点で警告 | 70-79: N2相当, 60-69: N3相当, <60: N4以下 |
| N2 | 70点 | < 60点で警告 | 60-69: N3相当, 50-59: N4相当, <50: N5以下 |
| N3 | 60点 | < 50点で警告 | 50-59: N4相当, 40-49: N5相当, <40: N5未満 |
| N4 | 50点 | < 40点で警告 | 40-49: N5相当, <40: N5未満 |
| N5 | 40点 | < 30点で警告 | <30: N5未満 |

### 7.9.3 乖離深刻度

| 深刻度 | 条件 | 対応 |
|--------|------|------|
| none | スコアが期待閾値以上 | 問題なし |
| minor | 期待閾値 - 10点以内 | 情報提供のみ |
| major | 期待閾値 - 20点以内 | Warning表示 |
| critical | 期待閾値 - 20点超 | Red Flag、再評価推奨 |

### 7.9.4 検出ロジック

```typescript
interface LevelMismatchResult {
  detected: boolean;
  declared_level: string;        // 申告レベル（N1-N5）
  actual_score: number;          // 実際の日本語能力スコア（0-100）
  estimated_level: string;       // 推定レベル（N1-N5 or "N5未満"）
  gap_severity: 'none' | 'minor' | 'major' | 'critical';
  evidence: string[];            // 乖離の根拠となるスコア詳細
  recommendation: string;        // 推奨アクション
}
```

### 7.9.5 推定レベル算出ロジック

日本語能力スコア（0-100点）から推定レベルを算出：

| スコア範囲 | 推定レベル |
|-----------|----------|
| 80-100点 | N1相当 |
| 70-79点 | N2相当 |
| 60-69点 | N3相当 |
| 50-59点 | N4相当 |
| 40-49点 | N5相当 |
| 0-39点 | N5未満 |

### 7.9.6 Warning Signsとの連携

乖離深刻度が`major`または`critical`の場合、Warning Signs（13_面接シナリオ設計 参照）として記録：

- **major**: 注意レベル（Warning）として記録
- **critical**: 即確認レベル（Red Flag）として記録
