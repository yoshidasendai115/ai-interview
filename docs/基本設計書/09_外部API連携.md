# 9. 外部API連携

## 9.0 外部API連携構成図

![外部API連携構成図](./images/設計書_9.0_外部API連携構成図.png)

本システムは4つの外部サービスと連携する。mintoku workとはSSO認証および評価結果の同期を行い、HeyGenはアバター生成・音声合成を担当、Google Cloud STTは音声認識を担当、OpenAI GPT-4oは回答の評価を担当する。

---

## 9.1 OpenAI GPT-4o

| 項目 | 内容 |
|------|------|
| 用途 | 日本語能力評価、採用適性評価、フィードバック生成、苦手分析 |
| モデル | gpt-4o |
| エンドポイント | Chat Completions API |
| コスト目安 | 約$0.05〜0.10/セッション |

### 評価内容

| 評価種別 | 詳細設計書 |
|---------|----------|
| 日本語能力評価（語彙・文法・内容・敬語） | 07_評価ロジック 7.1〜7.4節 |
| 採用適性評価（適応力・コミュニケーション力・主体性・定着意向・協調性） | 13_面接シナリオ設計 13.2節 |
| フィードバック生成・苦手分析 | 07_評価ロジック 7.5節 |

### エラーハンドリング

| エラー種別 | 対応処理 |
|-----------|---------|
| レート制限（429） | リトライ（指数バックオフ: 1秒→2秒→4秒、最大3回） |
| タイムアウト | 30秒でタイムアウト、リトライ |
| API障害 | 評価失敗として記録、ユーザーに再評価ボタンを表示 |

---

## 9.2 Google Cloud Speech-to-Text

| 項目 | 内容 |
|------|------|
| 用途 | 音声認識（ユーザー回答の文字起こし） |
| 言語モデル | ja-JP（日本語） |
| 接続方式 | WebSocketストリーミング |
| 音声フォーマット | WEBM_OPUS |
| サンプリングレート | 48000Hz |
| 無音検出 | 5秒間無音で自動停止 |

> **注意**: 音声合成（TTS）はHeyGen Streaming Avatarが担当するため、Google Cloud TTSは使用しない。

### エラーハンドリング

| エラー種別 | 対応処理 |
|-----------|---------|
| WebSocket接続失敗 | テキスト入力フォームにフォールバック |
| 認識精度低下 | 再録音を促すメッセージ表示 |
| マイク許可なし | 誘導ダイアログ表示 → テキスト入力へ |

---

## 9.3 HeyGen Streaming Avatar

| 項目 | 内容 |
|------|------|
| 用途 | 動的アバター生成（リップシンク対応）、面接官アバター、日本語TTS |
| SDK | `@heygen/streaming-avatar` |
| 接続方式 | WebRTCストリーミング |
| コスト | 約6クレジット/分、月額$99〜 |

### 選定理由

- TaskType.REPEAT による正確なセリフ発話が可能
- WebRTCストリーミングによる低レイテンシ
- 日本語TTS品質が高い
- SDK統合が容易（React対応）

### エラーハンドリング

| エラー種別 | 対応処理 |
|-----------|---------|
| WebRTC接続失敗 | 再接続試行（最大3回）→ テキストモードにフォールバック |
| 発話エラー | 質問テキストを画面表示で代替 |
| セッションタイムアウト | 60分で自動終了、途中結果を保存 |

> **詳細**: エラーハンドリングの詳細フローは **12_面接フロー制御 12.7節** を参照

### JLPTレベル別話速設定

| JLPTレベル | 話速（rate） | 説明 |
|-----------|------------|------|
| N1 | 1.0 | 通常速度 |
| N2 | 0.9 | やや遅め |
| N3 | 0.8 | 遅め |
| N4 | 0.7 | かなり遅め |
| N5 | 0.5 | 最も遅い |

> **詳細**: 話速設定の実装詳細は **12_面接フロー制御 12.2節** を参照

---

## 9.4 mintoku work（連携サービス）

本システムは「**mintoku work**」を起点とする。ユーザーはmintoku workから本システムに遷移して面接練習を行う。

### システム間の関係

![mintoku work連携図](./images/設計書_8.4_mintoku_work連携.png)

### 受信（mintoku work → 本システム）

| 項目 | 内容 |
|------|------|
| 用途 | SSO認証、ユーザー情報取得、ユーザー情報更新 |
| 認証方式 | OAuth 2.0 / OpenID Connect |
| 取得情報 | user_id, email, name, organization, jlpt_level, **preferred_industry**（希望業界） |
| 遷移方式 | トークン付きリンク（シームレス遷移） |
| Webhook認証 | HMAC署名検証（`X-Mintoku-Signature`ヘッダー） |

### 送信（本システム → mintoku work）

| 項目 | 内容 |
|------|------|
| 用途 | 面接練習の評価結果をmintoku workに反映 |
| エンドポイント | mintoku work側で用意するAPI |
| 送信タイミング | セッション完了後、評価処理完了時に自動送信 |
| 認証 | OAuth2 Client Credentials |
| リトライ | 最大3回（指数バックオフ: 1秒→2秒→4秒） |

> **送信データ形式**
> ※ 詳細な送信データ形式（JSON構造）は [10.6](./10_API仕様.md#106-外部api連携mintoku-work) を参照

### 利用フロー

```
1. ユーザーがmintoku workにログイン
2. mintoku work内の「AI面接練習」をクリック
3. 本システムに自動ログイン（シームレス遷移）
   - ユーザー情報取得（希望業界含む）
   - 学習計画の自動生成（初回または業界変更時）
4. 面接練習を実施
5. 練習完了 → 評価結果・学習進捗がmintoku workに自動送信
```

### 学習計画と希望業界

| 項目 | 内容 |
|------|------|
| 希望業界の連携 | mintoku workから1つの希望業界を受信 |
| 学習計画生成 | 希望業界に基づいて自動生成（詳細は12_面接フロー制御 12.10.3〜12.10.4節） |
| 業界変更時 | Webhook経由で通知を受け、学習計画を再生成 |

### 非ログイン時の業界変更Webhook処理

ユーザーがログインしていない状態で業界変更Webhookを受信した場合の対応。

#### Webhook受信時の処理分岐

```
Webhook受信（user.updated イベント）
   ↓
ユーザーのログイン状態を確認
   ├─ ログイン中
   │   → 即時適用
   │   → user_preferred_industries 更新
   │   → 業界変更確認ダイアログ表示（12_面接フロー制御 12.10.8節参照）
   │
   └─ 非ログイン（セッションなし）
       → users.pending_industry_id に保存
       → users.pending_industry_notified_at = NOW()
       → 次回ログイン時に適用
```

#### ログイン状態の判定方法

| 方法 | 説明 |
|------|------|
| セッション確認 | Redisに有効なセッションが存在するか |
| 最終アクティビティ | 直近5分以内にAPIリクエストがあったか |

#### 次回ログイン時の処理

```
1. ログイン処理
   ↓
2. users.pending_industry_id を確認
   ├─ NULLの場合 → 通常処理
   └─ 値がある場合 → ステップ3へ
   ↓
3. 業界変更確認ダイアログを表示
   ↓
4. ユーザーの選択に応じて処理
   ↓
5. pending_industry_id = NULL にクリア
```

> **詳細**: ログイン時の処理フローは **12_面接フロー制御 12.10.9節** を参照
