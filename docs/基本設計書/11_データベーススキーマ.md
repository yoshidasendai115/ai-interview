# 11. データベーススキーマ

## 11.1 テーブル一覧

| テーブル名（物理名） | 論理名 | 説明 |
|--------------------|--------|------|
| users | ユーザー | mintoku workから連携されたユーザー情報 |
| user_preferred_industries | ユーザー希望業界 | mintoku workから連携、1業界のみ |
| learning_plans | 学習計画 | 業界別カリキュラム |
| learning_steps | 学習ステップ | 計画内の各ステップ進捗 |
| interview_sessions | 面接セッション | 練習単位 |
| session_answers | セッション回答 | セッション内の各回答 |
| evaluations | 評価結果 | セッション単位の評価 |
| evaluation_details | 評価詳細 | 日本語能力評価の項目別スコア |
| aptitude_evaluations | 採用適性評価 | 5つの評価軸 |
| weak_points | 苦手項目 | ユーザー単位で蓄積 |
| question_categories | 質問カテゴリマスタ | 質問のカテゴリ分類 |
| industries | 業界マスタ | 特定技能対象業界 |
| question_bank | 質問バンク | 60問の質問データ |
| scenario_templates | シナリオテンプレート | 業界別面接シナリオ |
| scenario_template_questions | テンプレート質問関連 | テンプレートと質問の紐付け |

## 11.2 ER図

![ER図](../images/設計書_10.2_ER図.png)

## 11.3 テーブル定義

### users テーブル（ユーザー）

| カラム名 | 型 | NULL | 説明 |
|---------|-----|------|------|
| id | UUID | NO | 主キー |
| mintoku_user_id | VARCHAR(255) | NO | mintoku work側のユーザーID（ユニーク） |
| email | VARCHAR(255) | NO | メールアドレス（ユニーク） |
| name | VARCHAR(255) | NO | 氏名 |
| organization | VARCHAR(255) | YES | 所属組織 |
| jlpt_level | VARCHAR(2) | YES | JLPTレベル（N1-N5） |
| industry_synced_at | TIMESTAMP | YES | mintoku workから業界情報を同期した日時 |
| created_at | TIMESTAMP | NO | 作成日時 |
| updated_at | TIMESTAMP | NO | 更新日時 |

### user_preferred_industries テーブル（ユーザー希望業界）

mintoku workから連携される希望業界を保存するテーブル（1ユーザー1業界）。

| カラム名 | 型 | NULL | 説明 |
|---------|-----|------|------|
| id | UUID | NO | 主キー |
| user_id | UUID | NO | 外部キー → users.id（ユニーク） |
| industry_id | VARCHAR(50) | NO | 業界ID（例: construction, food_service） |
| created_at | TIMESTAMP | NO | 作成日時 |

**ユニーク制約:** `user_id` - 1ユーザーにつき1業界のみ

**データ例:**

| user_id | industry_id |
|---------|-------------|
| uuid-1 | construction |
| uuid-2 | nursing_care |

**希望業界なしの場合:** レコードが0件

### learning_plans テーブル（学習計画）

業界別学習計画を管理するテーブル。

| カラム名 | 型 | NULL | 説明 |
|---------|-----|------|------|
| id | UUID | NO | 主キー |
| user_id | UUID | NO | 外部キー → users.id |
| industry_id | VARCHAR(50) | YES | 対象業界ID（NULL = 汎用プラン） |
| scenario_template_id | VARCHAR(50) | NO | シナリオテンプレートID |
| status | VARCHAR(20) | NO | ステータス（active, completed, archived） |
| created_at | TIMESTAMP | NO | 作成日時 |
| updated_at | TIMESTAMP | NO | 更新日時 |

#### 学習計画ステータスの状態遷移

```
active → completed（全ステップ完了時）
       ↘ archived（業界変更時、旧プラン）
```

| ステータス | 説明 | 次のステータス |
|-----------|------|--------------|
| active | 進行中の学習計画 | completed / archived |
| completed | 全ステップ完了 | - |
| archived | 業界変更で無効化 | - |

### learning_steps テーブル（学習ステップ）

学習計画内の各ステップ（段階）を管理するテーブル。

| カラム名 | 型 | NULL | 説明 |
|---------|-----|------|------|
| id | UUID | NO | 主キー |
| learning_plan_id | UUID | NO | 外部キー → learning_plans.id |
| step_number | INTEGER | NO | ステップ番号（1, 2, 3...） |
| step_type | VARCHAR(30) | NO | ステップタイプ（introduction, practice, challenge） |
| jlpt_level | VARCHAR(2) | NO | このステップの対象JLPTレベル（N1-N5） |
| required_sessions | INTEGER | NO | 必要セッション数 |
| completed_sessions | INTEGER | NO | 完了セッション数（デフォルト: 0） |
| status | VARCHAR(20) | NO | ステータス（pending, in_progress, completed） |
| unlocked_at | TIMESTAMP | YES | 解放日時 |
| completed_at | TIMESTAMP | YES | 完了日時 |
| created_at | TIMESTAMP | NO | 作成日時 |

#### 学習ステップのステップタイプ

| ステップタイプ | 説明 |
|--------------|------|
| introduction | 基本的な自己紹介練習（導入） |
| practice | 実践練習（メイン学習） |
| challenge | チャレンジモード（上位レベル挑戦） |

#### 学習ステップステータスの状態遷移

```
pending → in_progress（前ステップ完了で解放）
                    ↘ completed（required_sessions達成）
```

### interview_sessions テーブル（面接セッション）

| カラム名 | 型 | NULL | 説明 |
|---------|-----|------|------|
| id | UUID | NO | 主キー |
| user_id | UUID | NO | 外部キー → users.id |
| industry_id | VARCHAR(50) | YES | 練習時の業界ID（例: construction, food_service） |
| jlpt_level | VARCHAR(2) | NO | 練習時のJLPTレベル（N1-N5） |
| is_challenge | BOOLEAN | NO | チャレンジモードで実施したか（デフォルト: false） |
| status | VARCHAR(20) | NO | ステータス（in_progress, completed, abandoned） |
| heygen_session_id | VARCHAR(255) | YES | HeyGenセッションID |
| started_at | TIMESTAMP | NO | 開始日時 |
| completed_at | TIMESTAMP | YES | 完了日時 |
| duration_seconds | INTEGER | YES | 所要時間（秒） |
| created_at | TIMESTAMP | NO | 作成日時 |

### session_answers テーブル（セッション回答）

| カラム名 | 型 | NULL | 説明 |
|---------|-----|------|------|
| id | UUID | NO | 主キー |
| session_id | UUID | NO | 外部キー → interview_sessions.id |
| question_id | VARCHAR(10) | NO | 外部キー → question_bank.id |
| question_order | INTEGER | NO | 質問順序 |
| audio_url | VARCHAR(500) | YES | 音声ファイルURL（S3） |
| transcript | TEXT | YES | 文字起こしテキスト |
| skipped | BOOLEAN | NO | スキップしたか（デフォルト: false） |
| answered_at | TIMESTAMP | NO | 回答日時 |
| created_at | TIMESTAMP | NO | 作成日時 |

### evaluations テーブル（評価結果）

| カラム名 | 型 | NULL | 説明 |
|---------|-----|------|------|
| id | UUID | NO | 主キー |
| session_id | UUID | NO | 外部キー → interview_sessions.id（ユニーク） |
| evaluation_status | VARCHAR(20) | NO | 評価ステータス（pending, processing, completed, failed）デフォルト: pending |
| total_score | INTEGER | YES | 総合スコア（0-100）※評価完了後に設定 |
| overall_feedback | TEXT | YES | 総合フィードバック |
| retry_count | INTEGER | NO | リトライ回数（デフォルト: 0） |
| last_error | TEXT | YES | 最後のエラーメッセージ |
| mintoku_sync_status | VARCHAR(20) | NO | mintoku work同期ステータス（pending, synced, failed） |
| mintoku_synced_at | TIMESTAMP | YES | mintoku work同期日時 |
| evaluated_at | TIMESTAMP | YES | 評価実行日時（評価完了後に設定） |
| created_at | TIMESTAMP | NO | 作成日時 |

#### 評価ステータスの状態遷移

```
pending → processing → completed
                    ↘ failed → processing（リトライ時）
```

| ステータス | 説明 | 次のステータス |
|-----------|------|--------------|
| pending | 評価待ち（セッション完了直後） | processing |
| processing | 評価処理中（GPT-4o呼び出し中） | completed / failed |
| completed | 評価完了 | - |
| failed | 評価失敗 | processing（リトライ時） |

#### リトライポリシー

| 項目 | 値 |
|------|-----|
| 最大リトライ回数 | 3回 |
| リトライ間隔 | 指数バックオフ（1秒, 2秒, 4秒） |
| リトライ対象エラー | タイムアウト、一時的なAPI障害 |
| リトライ非対象 | 認証エラー、不正なリクエスト |

### evaluation_details テーブル（評価詳細）

> **用途**: 日本語能力評価（07_評価ロジック）の項目別スコアを保存

| カラム名 | 型 | NULL | 説明 |
|---------|-----|------|------|
| id | UUID | NO | 主キー |
| evaluation_id | UUID | NO | 外部キー → evaluations.id |
| category | VARCHAR(50) | NO | 評価カテゴリ（vocabulary, grammar, content, honorifics） |
| score | INTEGER | NO | スコア（0-100） |
| feedback | TEXT | YES | カテゴリ別フィードバック |
| created_at | TIMESTAMP | NO | 作成日時 |

### aptitude_evaluations テーブル（採用適性評価）

> **用途**: 採用適性評価（07_評価ロジック 7.7節）の項目別スコアを保存

| カラム名 | 型 | NULL | 説明 |
|---------|-----|------|------|
| id | UUID | NO | 主キー |
| evaluation_id | UUID | NO | 外部キー → evaluations.id |
| category | VARCHAR(50) | NO | 評価カテゴリ（adaptability, communication, initiative, retention, cooperation） |
| score | DECIMAL(2,1) | NO | スコア（1.0-5.0） |
| feedback | TEXT | YES | カテゴリ別フィードバック |
| created_at | TIMESTAMP | NO | 作成日時 |

#### 評価カテゴリ対応表

| カテゴリID | 日本語名 | 重み |
|-----------|---------|-----|
| adaptability | 適応力 | 20% |
| communication | コミュニケーション力 | 25% |
| initiative | 主体性 | 20% |
| retention | 定着意向 | 20% |
| cooperation | 協調性 | 15% |

### weak_points テーブル（苦手項目）

| カラム名 | 型 | NULL | 説明 |
|---------|-----|------|------|
| id | UUID | NO | 主キー |
| user_id | UUID | NO | 外部キー → users.id |
| category | VARCHAR(50) | NO | カテゴリ（日本語能力: vocabulary, grammar, content, honorifics） |
| description | VARCHAR(255) | NO | 苦手項目の説明 |
| priority | VARCHAR(10) | NO | 優先度（high, medium, low） |
| occurrence_count | INTEGER | NO | 発生回数 |
| last_occurred_at | TIMESTAMP | NO | 最終発生日時 |
| resolved | BOOLEAN | NO | 解決済みか（デフォルト: false） |
| created_at | TIMESTAMP | NO | 作成日時 |
| updated_at | TIMESTAMP | NO | 更新日時 |

## 11.4 インデックス設計

| テーブル | インデックス | カラム | 目的 |
|---------|-------------|--------|------|
| users | idx_users_mintoku_id | mintoku_user_id | SSO認証時の検索 |
| users | idx_users_email | email | メールでの検索 |
| user_preferred_industries | idx_upi_user | user_id | ユーザー別希望業界取得（ユニーク） |
| learning_plans | idx_lp_user_status | user_id, status | ユーザー別アクティブプラン検索 |
| learning_steps | idx_ls_plan | learning_plan_id | プラン別ステップ取得 |
| learning_steps | idx_ls_plan_status | learning_plan_id, status | プラン別ステータス検索 |
| interview_sessions | idx_sessions_user_status | user_id, status | ユーザー別セッション検索 |
| interview_sessions | idx_sessions_completed | completed_at | 履歴表示用 |
| evaluations | idx_evaluations_sync | mintoku_sync_status | 同期バッチ処理用 |
| weak_points | idx_weakpoints_user | user_id, resolved | 苦手項目表示用 |
| aptitude_evaluations | idx_aptitude_eval | evaluation_id | 評価IDからの検索 |

## 11.5 シナリオ・質問バンク関連テーブル

### question_categories テーブル（質問カテゴリマスタ）

質問カテゴリ（導入、過去、現在、未来、条件確認、クロージング）を管理するマスタテーブル。

| カラム名 | 型 | NULL | 説明 |
|---------|-----|------|------|
| id | VARCHAR(50) | NO | 主キー（例: introduction, past_experience） |
| name | VARCHAR(100) | NO | カテゴリ名（日本語） |
| name_en | VARCHAR(100) | NO | カテゴリ名（英語） |
| time_axis | VARCHAR(20) | YES | 時間軸（past, present, future, null） |
| duration_minutes | INTEGER | NO | 想定所要時間（分） |
| display_order | INTEGER | NO | 表示順序 |
| description | TEXT | YES | カテゴリの説明 |
| purpose | TEXT | YES | カテゴリの目的 |
| created_at | TIMESTAMP | NO | 作成日時 |
| updated_at | TIMESTAMP | NO | 更新日時 |

### industries テーブル（業界マスタ）

外国人採用の対象業界を管理するマスタテーブル。

> **※ 正式な業界マスターデータは `backend/app/data/seed/industries.json` を参照**

#### サポートする業界ID（7業界）

| industry_id | 業界名（日本語） | 業界名（英語） |
|-------------|-----------------|---------------|
| nursing_care | 介護 | Nursing Care |
| food_service | 飲食 | Food Service |
| construction | 建設 | Construction |
| manufacturing | 製造 | Manufacturing |
| hospitality | 宿泊 | Hospitality |
| agriculture | 農業 | Agriculture |
| building_cleaning | ビルクリーニング | Building Cleaning |

| カラム名 | 型 | NULL | 説明 |
|---------|-----|------|------|
| id | VARCHAR(50) | NO | 主キー（例: nursing_care, food_service） |
| name | VARCHAR(100) | NO | 業界名（日本語） |
| name_en | VARCHAR(100) | NO | 業界名（英語） |
| specific_skill_category | VARCHAR(100) | YES | 特定技能分野カテゴリ |
| description | TEXT | YES | 業界の説明 |
| key_requirements | JSONB | YES | 業界特有の要件（配列） |
| priority_evaluation_categories | JSONB | YES | 重点評価カテゴリ（配列） |
| common_job_titles | JSONB | YES | 一般的な職種名（配列） |
| physical_demands | VARCHAR(20) | YES | 身体的負荷レベル（low, medium, high, very_high） |
| communication_level_required | VARCHAR(2) | YES | 必要なJLPTレベル |
| additional_questions | JSONB | YES | 業界固有の追加質問（配列） |
| created_at | TIMESTAMP | NO | 作成日時 |
| updated_at | TIMESTAMP | NO | 更新日時 |

### question_bank テーブル（質問バンク）

面接で使用する60問の質問を管理するテーブル。

| カラム名 | 型 | NULL | 説明 |
|---------|-----|------|------|
| id | VARCHAR(10) | NO | 主キー（例: Q01, Q02） |
| category_id | VARCHAR(50) | NO | 外部キー → question_categories.id |
| question_ja | TEXT | NO | 質問文（標準版） |
| question_simplified | TEXT | NO | 質問文（簡易版 N4-N5向け） |
| question_reading | TEXT | YES | ふりがな付き質問文 |
| difficulty | INTEGER | NO | 難易度（1-3） |
| industries | JSONB | NO | 対象業界（配列、allで全業界） |
| evaluation_points | JSONB | YES | 評価ポイント（配列） |
| follow_ups | JSONB | YES | フォローアップ質問（配列） |
| good_answer_indicators | JSONB | YES | 良い回答の指標（配列） |
| red_flags | JSONB | YES | 注意すべき回答パターン（配列） |
| is_ice_breaker | BOOLEAN | NO | アイスブレイク質問か（デフォルト: false） |
| is_condition_check | BOOLEAN | NO | 条件確認質問か（デフォルト: false） |
| is_closing_statement | BOOLEAN | NO | クロージング文か（デフォルト: false） |
| source | VARCHAR(100) | YES | 質問の出典 |
| created_at | TIMESTAMP | NO | 作成日時 |
| updated_at | TIMESTAMP | NO | 更新日時 |

### scenario_templates テーブル（シナリオテンプレート）

業界・JLPTレベル別のシナリオテンプレートを管理するテーブル。

| カラム名 | 型 | NULL | 説明 |
|---------|-----|------|------|
| id | VARCHAR(50) | NO | 主キー（例: standard_45min, nursing_care_focused） |
| name | VARCHAR(100) | NO | テンプレート名（日本語） |
| name_en | VARCHAR(100) | NO | テンプレート名（英語） |
| description | TEXT | YES | テンプレートの説明 |
| duration_minutes | INTEGER | NO | 想定所要時間（分） |
| jlpt_levels | JSONB | NO | 対象JLPTレベル（配列） |
| industries | JSONB | NO | 対象業界（配列） |
| flow | JSONB | NO | シナリオフロー（各フェーズの質問ID等） |
| created_at | TIMESTAMP | NO | 作成日時 |
| updated_at | TIMESTAMP | NO | 更新日時 |

### scenario_template_questions テーブル（テンプレート質問関連）

シナリオテンプレートと質問の関連を管理する中間テーブル。

| カラム名 | 型 | NULL | 説明 |
|---------|-----|------|------|
| id | UUID | NO | 主キー |
| template_id | VARCHAR(50) | NO | 外部キー → scenario_templates.id |
| question_id | VARCHAR(10) | NO | 外部キー → question_bank.id |
| phase | VARCHAR(50) | NO | シナリオフェーズ |
| order_in_phase | INTEGER | NO | フェーズ内での質問順序 |
| is_required | BOOLEAN | NO | 必須質問か（デフォルト: true） |
| notes | TEXT | YES | 質問時の注意事項 |
| created_at | TIMESTAMP | NO | 作成日時 |

## 11.6 シナリオ関連インデックス

| テーブル | インデックス | カラム | 目的 |
|---------|-------------|--------|------|
| question_bank | idx_qbank_category | category_id | カテゴリ別質問検索 |
| question_bank | idx_qbank_difficulty | difficulty | 難易度別検索 |
| scenario_templates | idx_templates_industry | industries | 業界別テンプレート検索 |
| scenario_template_questions | idx_stq_template | template_id | テンプレート別質問取得 |
| scenario_template_questions | idx_stq_question | question_id | 質問別テンプレート取得 |

## 11.7 データ整合性ルール

### 質問削除時の整合性管理

`session_answers.question_id` は `question_bank.id` を参照するため、質問の削除には特別な配慮が必要です。

#### 方針: 論理削除（物理削除禁止）

| ルール | 内容 |
|-------|------|
| 物理削除禁止 | 質問データは物理削除しない |
| 論理削除 | `is_deleted` フラグで管理 |
| 過去データ保護 | 回答データとの紐付けを維持 |
| バージョン管理 | 質問内容の変更履歴を保持 |

#### question_bank テーブルの追加カラム

| カラム名 | 型 | NULL | 説明 |
|---------|-----|------|------|
| is_deleted | BOOLEAN | NO | 論理削除フラグ（デフォルト: false） |
| deleted_at | TIMESTAMP | YES | 削除日時 |
| version | INTEGER | NO | バージョン番号（デフォルト: 1） |

#### 外部キー制約設計

```sql
-- session_answersテーブルの外部キー制約
ALTER TABLE session_answers
ADD CONSTRAINT fk_session_answers_question
FOREIGN KEY (question_id) REFERENCES question_bank(id)
ON DELETE RESTRICT  -- 削除を禁止
ON UPDATE CASCADE;  -- ID変更時は連動
```

#### 質問変更時のバージョン管理

質問内容を変更する場合、新しいバージョンを作成して過去データとの整合性を保持。

```sql
-- 質問更新時の処理
BEGIN TRANSACTION;

-- 現在の質問を論理削除
UPDATE question_bank
SET is_deleted = true, deleted_at = NOW()
WHERE id = 'Q01' AND is_deleted = false;

-- 新しいバージョンを作成
INSERT INTO question_bank (
    id, category_id, question_ja, question_simplified,
    difficulty, industries, version, created_at
) VALUES (
    'Q01', 'introduction', '更新後の質問文', '簡易版',
    1, '["all"]',
    (SELECT COALESCE(MAX(version), 0) + 1 FROM question_bank WHERE id = 'Q01'),
    NOW()
);

COMMIT;
```

#### 質問取得時のフィルタリング

```sql
-- アクティブな質問のみ取得
SELECT * FROM question_bank
WHERE is_deleted = false
ORDER BY category_id, id;

-- 特定時点の質問を取得（過去の回答データ参照用）
SELECT * FROM question_bank
WHERE id = 'Q01'
  AND created_at <= '2025-01-30T00:00:00Z'
  AND (deleted_at IS NULL OR deleted_at > '2025-01-30T00:00:00Z')
ORDER BY version DESC
LIMIT 1;
```

### 整合性チェックバッチ

定期的に整合性をチェックするバッチ処理を実行。

| チェック項目 | 頻度 | アラート条件 |
|-------------|------|-------------|
| 孤立した回答データ | 日次 | question_idが存在しない回答 |
| 削除済み質問の参照 | 日次 | 最近のセッションで削除済み質問を参照 |
| バージョン不整合 | 週次 | 同一IDで複数のアクティブバージョン |
