# 14. セキュリティ設計

## 14.1 セキュリティ多層防御アーキテクチャ

本システムでは、多層防御（Defense in Depth）アーキテクチャを採用し、各レイヤーで異なる種類の攻撃をブロックします。

![セキュリティ多層防御図](../images/設計書_14_セキュリティ多層防御図.png)

### 各レイヤーの防御機能

| レイヤー | 構成要素 | 防御対象の攻撃 | 主な防御機能 |
|---------|---------|---------------|-------------|
| **Layer 1: エッジ** | CloudFront + WAF | DDoS、SQLi、XSS、Bot攻撃、不正アクセス | Geo制限、レート制限、Bot Control、パターンマッチング、IPブロック |
| **Layer 2: ネットワーク** | ALB / API Gateway | 中間者攻撃、不正オリジン | TLS 1.3終端、CORS検証、セキュリティヘッダー |
| **Layer 3: アプリケーション** | FastAPI | 認証突破、SSRF、権限昇格、Bot攻撃 | JWT認証、RBAC、入力バリデーション、SSRF対策、行動分析 |
| **Layer 4: データ** | RDS / S3 / Redis | データ漏洩、不正アクセス | 保存時暗号化、アクセス制御、監査ログ |

### 攻撃シナリオと防御ポイント

| 攻撃シナリオ | ブロックレイヤー | 防御機能 |
|-------------|-----------------|---------|
| 海外からの大量リクエスト（DDoS） | Layer 1 (WAF) | Geo制限 + レート制限 |
| SQLインジェクション | Layer 1 (WAF) | SQLi検知ルール |
| XSSスクリプト挿入 | Layer 1 (WAF) | XSS検知ルール |
| **Bot（クレデンシャルスタッフィング）** | **Layer 1 + 3** | **Bot Control + レート制限 + 行動分析** |
| **Bot（スクレイピング）** | **Layer 1 (WAF)** | **Bot Control + User-Agent検証** |
| **Bot（API乱用）** | **Layer 1 + 3** | **レート制限（IP/ユーザー別）** |
| 不正なJWTトークン | Layer 3 (FastAPI) | JWT検証 |
| 他ユーザーのデータアクセス | Layer 3 (FastAPI) | RBAC + アクセス制御 |
| SSRF（内部システムへの攻撃） | Layer 3 (FastAPI) | 許可ドメインリスト検証 |
| 通信傍受（中間者攻撃） | Layer 2 (ALB) | TLS 1.3暗号化 |

---

## 14.2 認証フロー

![認証フロー図](../images/設計書_12.1_認証フロー.png)

## 14.3 JWT仕様

### アクセストークン

| 項目 | 値 |
|------|-----|
| アルゴリズム | RS256（RSA署名） |
| 有効期限 | 1時間（3600秒） |
| 発行者（iss） | https://api.ai-interview.example.com |
| 対象者（aud） | ai-interview-app |

### ペイロード構造

```json
{
  "sub": "usr_123456",
  "iss": "https://api.ai-interview.example.com",
  "aud": "ai-interview-app",
  "exp": 1706630400,
  "iat": 1706626800,
  "mintoku_user_id": "mintoku_user_123",
  "email": "user@example.com",
  "jlpt_level": "N3",
  "roles": ["user"]
}
```

### リフレッシュトークン

| 項目 | 値 |
|------|-----|
| 形式 | ランダム文字列（256bit） |
| 有効期限 | 30日 |
| 保存場所 | Redis（ElastiCache） |
| 使用回数 | 1回使い切り（ローテーション） |

## 14.4 CORS設定

```python
# FastAPI CORS設定
from fastapi.middleware.cors import CORSMiddleware

app.add_middleware(
    CORSMiddleware,
    allow_origins=[
        "https://ai-interview.example.com",
        "https://app.ai-interview.example.com",
        "https://www.mintoku-work.com"
    ],
    allow_credentials=True,
    allow_methods=["GET", "POST", "PUT", "DELETE"],
    allow_headers=["Authorization", "Content-Type"],
    max_age=86400  # 24時間
)
```

## 14.5 API認証

### Bearer Token認証

すべてのAPIリクエストにはAuthorizationヘッダーが必要です（認証エンドポイントを除く）。

```
Authorization: Bearer eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...
```

### 認証不要エンドポイント

| エンドポイント | 説明 |
|---------------|------|
| POST /api/v1/auth/sso/callback | SSO認証コールバック |
| GET /api/v1/health | ヘルスチェック |

## 14.6 mintoku work連携セキュリティ

### SSO認証（mintoku work → 本システム）

| 項目 | 値 |
|------|-----|
| プロトコル | OAuth 2.0 / OpenID Connect |
| トークン署名 | HMAC-SHA256 |
| 共有秘密鍵 | AWS Secrets Managerで管理 |
| トークン有効期限 | 5分（ワンタイム） |

### API連携（本システム → mintoku work）

| 項目 | 値 |
|------|-----|
| 認証方式 | OAuth2 Client Credentials |
| スコープ | interview-results:write |
| トークンエンドポイント | https://api.mintoku-work.com/oauth/token |
| 結果送信エンドポイント | https://api.mintoku-work.com/v1/interview-results |

## 14.7 データ保護

### 暗号化ポリシー

| データ種別 | 保存時暗号化 | 転送時暗号化 |
|-----------|-------------|-------------|
| ユーザー情報 | AES-256（RDS暗号化） | TLS 1.3 |
| 音声データ | SSE-S3（S3暗号化） | TLS 1.3 |
| セッションデータ | AES-256（Redis暗号化） | TLS 1.3 |
| APIキー・秘密鍵 | AWS Secrets Manager | TLS 1.3 |

### 個人情報の取り扱い

| 項目 | 対応 |
|------|------|
| 保存期間 | 音声データ: 90日、評価データ: 2年 |
| 削除要求 | ユーザーからの削除要求に30日以内に対応 |
| アクセス制限 | ユーザーは自身のデータのみアクセス可能 |
| ログ記録 | 個人情報へのアクセスはすべてログ記録 |

## 14.8 セキュリティヘッダー

```python
# FastAPIセキュリティミドルウェア
@app.middleware("http")
async def add_security_headers(request, call_next):
    response = await call_next(request)
    response.headers["X-Content-Type-Options"] = "nosniff"
    response.headers["X-Frame-Options"] = "DENY"
    response.headers["X-XSS-Protection"] = "1; mode=block"
    response.headers["Strict-Transport-Security"] = "max-age=31536000; includeSubDomains"
    response.headers["Content-Security-Policy"] = "default-src 'self'; script-src 'self'"
    return response
```

## 14.9 レート制限

| エンドポイント種別 | 制限 |
|-------------------|------|
| 認証API | 10リクエスト/分/IP |
| セッションAPI | 60リクエスト/分/ユーザー |
| 評価API | 30リクエスト/分/ユーザー |
| 全体 | 1000リクエスト/分/IP |

## 14.10 監査ログ

| イベント | 記録内容 |
|---------|---------|
| ログイン成功/失敗 | user_id, IP, User-Agent, timestamp |
| セッション開始/完了 | session_id, user_id, timestamp |
| 評価結果参照 | evaluation_id, user_id, timestamp |
| mintoku work同期 | session_id, status, timestamp |
| エラー発生 | error_type, stack_trace, timestamp |

## 14.11 WAF（Web Application Firewall）

### WAFルール構成

| ルール種別 | ルール名 | 用途 | 優先度 |
|-----------|---------|------|--------|
| AWS マネージドルール | AWSManagedRulesCommonRuleSet | OWASP Top 10対策 | 1 |
| AWS マネージドルール | AWSManagedRulesKnownBadInputsRuleSet | 既知の悪意あるパターン | 2 |
| AWS マネージドルール | AWSManagedRulesSQLiRuleSet | SQLインジェクション | 3 |
| AWS マネージドルール | AWSManagedRulesLinuxRuleSet | Linux固有の攻撃 | 4 |
| **AWS マネージドルール** | **AWSManagedRulesBotControlRuleSet** | **Bot検知・ブロック** | **5** |
| カスタムルール | RateLimitRule | DDoS/ブルートフォース防止 | 6 |
| カスタムルール | GeoMatchRule | 特定国のみ許可 | 7 |
| カスタムルール | AuthEndpointProtection | 認証エンドポイント保護 | 8 |
| カスタムルール | IPBlockRule | 悪意あるIP遮断 | 9 |

### レート制限設定

| エンドポイント | 制限値 | 期間 | 理由 |
|---------------|-------|------|------|
| 全体 | 2000リクエスト | 5分 | DDoS防止 |
| `/api/v1/auth/*` | 50リクエスト | 5分 | ブルートフォース防止 |
| `/api/v1/sessions` | 100リクエスト | 5分 | セッション乱立防止 |

### Geo制限（許可する国）

本システムは東南アジア向けのため、以下の国からのアクセスのみ許可。

| 許可する国 | 国コード |
|-----------|---------|
| 日本 | JP |
| ベトナム | VN |
| フィリピン | PH |
| インドネシア | ID |
| タイ | TH |
| ミャンマー | MM |
| カンボジア | KH |
| ネパール | NP |

> ※開発環境では開発者のIPを許可リストに追加

### SQLインジェクション対策

| 検知パターン | 対応 |
|-------------|------|
| SELECT, INSERT, UPDATE, DELETE文 | ブロック |
| UNION句 | ブロック |
| コメント挿入（`--`, `/*`, `*/`） | ブロック |
| 文字列エスケープ | ブロック |

### XSS対策

| 検知パターン | 対応 |
|-------------|------|
| `<script>`タグ | ブロック |
| イベントハンドラ（onclick, onerror等） | ブロック |
| `javascript:` URI | ブロック |
| `data:` URI | ブロック |

### 認証エンドポイント保護

| 対策 | 設定 |
|------|------|
| ログイン試行制限 | 10回/分/IP |
| トークンリフレッシュ制限 | 30回/分/IP |
| 連続失敗時のブロック | 5回連続失敗 → 15分ブロック |

### Bot対策（AWS WAF Bot Control）

APIエンドポイントへのBot攻撃を多層的に防御します。

#### Bot攻撃の種類と防御レイヤー

| Bot攻撃の種類 | 説明 | 防御レイヤー | 防御機能 |
|--------------|------|-------------|---------|
| クレデンシャルスタッフィング | 漏洩した認証情報を使った自動ログイン試行 | Layer 1 + 3 | Bot Control + レート制限 + 行動分析 |
| スクレイピングBot | データの自動収集 | Layer 1 | Bot Control + User-Agent検証 |
| API乱用Bot | 大量のAPIリクエスト | Layer 1 + 3 | レート制限（IP/ユーザー別） |
| アカウント乗っ取りBot | セッションハイジャック試行 | Layer 3 | JWT検証 + セッション監視 |
| 偽アカウント作成Bot | 大量アカウント作成 | Layer 1 + 3 | CAPTCHA + 行動分析 |

#### AWS WAF Bot Control設定

| 設定項目 | 値 | 説明 |
|---------|-----|------|
| 検査レベル | Common | 一般的なBot検知 |
| ターゲットルール | TGT_* | すべてのBot Controlルール有効 |
| 除外Bot | 検索エンジン（Googlebot等） | 許可リストで管理 |
| アクション | Block / CAPTCHA | Botの種類に応じて切替 |

#### Bot検知シグナル

| シグナル | 検知内容 | 対応 |
|---------|---------|------|
| User-Agent異常 | 既知のBot User-Agent、空、不正な形式 | ブロック |
| リクエストパターン | 人間らしくないアクセス間隔 | CAPTCHA表示 |
| JavaScript実行不可 | ヘッドレスブラウザの可能性 | チャレンジ |
| フィンガープリント異常 | ブラウザ特性の不一致 | 警告ログ + 監視 |
| IPレピュテーション | 既知の悪意あるIP/プロキシ | ブロック |

#### アプリケーションレベルのBot対策（Layer 3）

| 対策 | 実装 | 説明 |
|------|------|------|
| 行動分析 | リクエスト間隔・パターン監視 | 人間らしくない操作を検知 |
| セッション監視 | 同一セッションの異常検知 | 急激なアクティビティ変化を検知 |
| CAPTCHA連携 | reCAPTCHA v3 | リスクスコアに基づくチャレンジ |
| デバイスフィンガープリント | ブラウザ特性収集 | 同一デバイスからの異常検知 |

### リクエストサイズ制限

| 項目 | 制限値 | 理由 |
|------|-------|------|
| Body最大サイズ | 10MB | 音声データアップロード対応 |
| URI最大長 | 8KB | 標準的な制限 |
| ヘッダー最大サイズ | 16KB | JWT含むため |

### WAFログ設定

| 設定 | 値 |
|------|-----|
| 出力先 | S3 + CloudWatch Logs |
| 保持期間 | 90日 |
| サンプリング | 有効 |
| メトリクス | CloudWatch連携 |

## 14.12 SSRF対策

### 外部API呼び出し時のURL検証

本システムは複数の外部APIと連携するため、SSRF（Server-Side Request Forgery）対策を実施。

| 対策 | 内容 |
|------|------|
| 許可リスト方式 | 接続先は許可されたドメインのみ |
| プライベートIP遮断 | 10.0.0.0/8、172.16.0.0/12、192.168.0.0/16への接続を禁止 |
| メタデータサービス遮断 | 169.254.169.254へのアクセスを禁止 |
| URLスキーム制限 | https://のみ許可（http://、file://等は禁止） |
| リダイレクト制限 | リダイレクトは許可ドメイン内のみ追跡 |

### 許可ドメインリスト

| 外部API | 許可ドメイン |
|---------|-------------|
| HeyGen | api.heygen.com |
| Google Cloud STT | speech.googleapis.com |
| OpenAI | api.openai.com |
| mintoku work | api.mintoku-work.com |

### 実装例

```python
from urllib.parse import urlparse
import ipaddress

ALLOWED_DOMAINS = [
    "api.heygen.com",
    "speech.googleapis.com",
    "api.openai.com",
    "api.mintoku-work.com"
]

BLOCKED_IP_RANGES = [
    ipaddress.ip_network("10.0.0.0/8"),
    ipaddress.ip_network("172.16.0.0/12"),
    ipaddress.ip_network("192.168.0.0/16"),
    ipaddress.ip_network("169.254.0.0/16"),
    ipaddress.ip_network("127.0.0.0/8"),
]

def validate_url(url: str) -> bool:
    parsed = urlparse(url)

    # スキーム検証
    if parsed.scheme != "https":
        return False

    # ドメイン検証
    if parsed.hostname not in ALLOWED_DOMAINS:
        return False

    return True
```

## 14.13 依存関係管理

### セキュリティスキャン

| ツール | 対象 | 実行タイミング |
|-------|------|---------------|
| npm audit | Node.js依存関係 | CI/CD、週次 |
| pip-audit | Python依存関係 | CI/CD、週次 |
| Dependabot | GitHub依存関係 | 自動（PR作成） |
| Snyk | 全依存関係 | CI/CD、週次 |

### 脆弱性対応ポリシー

| 重要度 | 対応期限 | アクション |
|-------|---------|-----------|
| Critical | 24時間以内 | 即座にパッチ適用または回避策実施 |
| High | 7日以内 | パッチ適用 |
| Medium | 30日以内 | 次回リリースで対応 |
| Low | 90日以内 | 計画的に対応 |

### CI/CDでの自動チェック

```yaml
# GitHub Actions例
security-scan:
  runs-on: ubuntu-latest
  steps:
    - name: npm audit
      run: npm audit --audit-level=high

    - name: pip-audit
      run: pip-audit --require-hashes

    - name: Snyk scan
      uses: snyk/actions/node@master
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
```

### 依存関係更新ルール

| ルール | 内容 |
|-------|------|
| メジャーバージョン | 手動確認後にマージ |
| マイナーバージョン | テスト通過後に自動マージ |
| パッチバージョン | テスト通過後に自動マージ |
| セキュリティ修正 | 優先的に対応（重要度に応じた期限内） |
