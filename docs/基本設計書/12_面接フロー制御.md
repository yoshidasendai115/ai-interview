# 12. 面接フロー制御

## 12.1 面接セッション全体フロー

![面接フローシーケンス図](../images/設計書_11.1_面接フロー.png)

## 12.2 HeyGen Streaming Avatar統合

### セッション開始シーケンス

```
1. ユーザーが「面接を始める」をタップ
   ↓
2. フロントエンド → バックエンド: POST /api/v1/sessions
   ↓
3. バックエンド: スクリプト取得、セッションレコード作成
   ↓
4. バックエンド → HeyGen API: createStreamingSession()
   ↓
5. HeyGen: WebRTCセッション確立、session_token返却
   ↓
6. バックエンド → フロントエンド: セッション情報 + HeyGenトークン
   ↓
7. フロントエンド: HeyGen SDKでアバター接続
   ↓
8. アバター接続完了 → 面接開始
```

### HeyGen SDK設定

```typescript
import StreamingAvatar, {
  TaskType,
  AvatarQuality,
  VoiceEmotion
} from "@heygen/streaming-avatar";

const avatar = new StreamingAvatar({
  token: sessionToken
});

// JLPTレベル別の話速設定
const JLPT_VOICE_RATE: Record<string, number> = {
  "N1": 1.0,   // 通常
  "N2": 1.0,   // 通常
  "N3": 0.75,  // ゆっくり
  "N4": 0.5,   // かなりゆっくり
  "N5": 0.5,   // かなりゆっくり
};

// アバター開始（JLPTレベルに応じた話速設定）
await avatar.createStartAvatar({
  avatarName: "wayne_asian_male",
  language: "ja",
  quality: AvatarQuality.High,
  voice: {
    voiceId: "jp_male_voice",
    rate: JLPT_VOICE_RATE[userJlptLevel],  // 0.5〜1.5
    emotion: VoiceEmotion.FRIENDLY,
  },
});

// 質問発話（セリフ通り）
await avatar.speak({
  text: "自己紹介をお願いします。",
  taskType: TaskType.REPEAT
});
```

> **注意**: `voice.rate`はセッション開始時のみ設定可能。セッション中の動的変更は不可。

## 12.3 JLPTレベル別質問取得（API連携）

### 12.3.1 APIエンドポイント

```
GET /api/questions?jlptLevel=N3
```

#### レスポンス

```json
{
  "jlptLevel": "N3",
  "totalQuestions": 10,
  "questions": [
    {
      "id": "Q01",
      "order": 1,
      "text": "本日はお越しいただきありがとうございます...",
      "spokenText": "ほんじつはおこしいただき...",
      "expectedDurationSeconds": 60,
      "evaluationCriteria": ["communication"]
    }
  ]
}
```

### 12.3.2 質問取得フロー

```
1. InterviewSessionコンポーネントがJLPTレベルをpropsで受け取る
   ↓
2. 面接開始時にfetch('/api/questions?jlptLevel=N3')でAPIを呼び出し
   ↓
3. APIが質問バンク（60問）からカテゴリ別に10問を選択
   ↓
4. JLPTレベルに応じてテキストを選択
   - N1-N3: question_ja（標準）
   - N4-N5: question_simplified（簡易版）
   ↓
5. stateMachine.startInterview(questions)で質問セットを設定
   ↓
6. 各質問のtext（画面表示用）とspokenText（発話用）を使用
```

### 12.3.3 Question型定義

```typescript
interface Question {
  id: string;
  order: number;
  /** 画面表示用テキスト */
  text: string;
  /** HeyGen発話用テキスト（読み仮名） */
  spokenText?: string;
  expectedDurationSeconds: number;
  evaluationCriteria: string[];
}
```

### 12.3.4 カテゴリ別選択数

| カテゴリ | 選択数 |
|----------|--------|
| introduction | 2問 |
| past_experience | 2問 |
| present_ability | 2問 |
| future_vision | 2問 |
| closing | 2問 |
| **合計** | **10問** |

## 12.4 質問・回答ループ

![質問・回答ループ](../images/設計書_11.3_質問回答ループ.png)

## 12.5 Google Cloud STT統合

### リアルタイム音声認識設定

```typescript
const speechConfig = {
  encoding: "WEBM_OPUS",
  sampleRateHertz: 48000,
  languageCode: "ja-JP",
  enableAutomaticPunctuation: true,
  model: "latest_long",
  useEnhanced: true
};
```

### 音声入力フロー

```
1. マイクボタンタップ → MediaRecorder開始
   ↓
2. 音声データをWebSocketでバックエンドに送信
   ↓
3. バックエンド → Google Cloud STT（Streaming API）
   ↓
4. 中間結果をリアルタイムでフロントエンドに返却
   ↓
5. 最終結果確定 → 回答テキストとして保存
   ↓
6. 5秒間無音検出 → 自動停止
```

## 12.6 セッション完了処理

```
1. 最後の質問回答完了
   ↓
2. フロントエンド → バックエンド: PUT /api/v1/sessions/{id}/complete
   ↓
3. バックエンド: HeyGenセッション終了
   ↓
4. バックエンド: 評価処理（非同期）
   ├─ 4a. 日本語能力評価（GPT-4o）
   │      - 各回答の語彙・文法・内容・敬語を評価
   │      - evaluation_detailsテーブルに保存
   │      - 詳細: 07_評価ロジック
   │
   └─ 4b. 採用適性評価（GPT-4o）
          - セッション全体から適応力・コミュニケーション力・主体性・定着意向・協調性を評価
          - aptitude_evaluationsテーブルに保存
          - 詳細: 13_面接シナリオ設計
   ↓
5. 両評価を統合 → evaluationsテーブルに総合スコアを保存
   ↓
6. mintoku workへ統合結果を送信
   ↓
7. フロントエンド: フィードバック画面へ遷移
```

### 12.6.1 評価処理の詳細

| 評価種別 | 評価対象 | スコア範囲 | 保存先テーブル |
|---------|---------|----------|--------------|
| 日本語能力評価 | 語彙・文法・内容・敬語 | 0-100点 | evaluation_details |
| 採用適性評価 | 適応力・コミュニケーション力・主体性・定着意向・協調性 | 1-5点 | aptitude_evaluations |
| 統合スコア | 上記2つの加重平均 | 0-100点 | evaluations.total_score |

### 12.6.2 統合スコア計算

統合スコアの計算方法については **07_評価ロジック 7.7.2節** を参照。

## 12.7 エラーハンドリング

| エラー種別 | 検出方法 | 対応処理 |
|-----------|---------|---------|
| HeyGen接続失敗 | WebRTC接続エラー | 再接続試行（最大3回）→ テキストモードにフォールバック |
| HeyGen発話エラー | speak() Promise reject | 質問テキストを画面表示で代替 |
| STT接続失敗 | WebSocketエラー | テキスト入力フォームを表示 |
| STT認識失敗 | 空の認識結果 | 再録音を促すメッセージ表示 |
| ネットワーク切断 | navigator.onLine監視 | 再接続待ち画面表示、自動復帰試行 |
| セッションタイムアウト | 30分経過 | セッション中断、途中結果を保存 |

## 12.8 状態管理

```typescript
type SessionState =
  | "initializing"    // HeyGen接続中
  | "ready"           // 接続完了、開始待ち
  | "avatar_speaking" // アバター発話中
  | "listening"       // ユーザー回答待ち
  | "processing"      // 回答処理中
  | "completed"       // セッション完了
  | "error";          // エラー状態

interface SessionContext {
  state: SessionState;
  currentQuestion: number;
  totalQuestions: number;
  answers: Answer[];
  heygenSessionId: string | null;
  sttConnection: WebSocket | null;
}
```

## 12.9 適応型JLPTレベル調整フロー

### 12.9.1 概要

面接評価スコアに基づいて、次回の面接で使用するJLPTレベルを自動調整する。
詳細な調整ルールは **07_評価ロジック 7.10節** を参照。

### 12.9.2 レベル調整フロー

```
1. 面接セッション完了
   ↓
2. 評価スコア算出（0-100点）
   ↓
3. スコア判定
   ├─ 70点以上 → レベルアップ推奨
   ├─ 31〜69点 → 同レベル継続（上位挑戦オプションあり）
   └─ 30点以下 → レベルダウン推奨
   ↓
4. フィードバック画面でボタン表示
   ↓
5. ユーザー選択 or 自動遷移
   ↓
6. 次回セッションのJLPTレベル決定
```

### 12.9.3 チャレンジ枠フロー

```
1. ユーザーがアバター接続完了（ready状態）
   ↓
2. 「チャレンジ枠で挑戦（N○）」ボタン表示
   - 条件: 申告レベルがN1以外 かつ 残り回数 > 0
   ↓
3. ユーザーがチャレンジ枠を選択
   ↓
4. currentLevelを1つ上のレベルに変更
   ↓
5. isChallengeMode = true に設定
   ↓
6. 面接開始（上位レベルの質問セット）
   ↓
7. セッション完了時にチャレンジ回数をカウント
```

### 12.9.4 チャレンジ回数のリセット

- 1日（00:00 JST）ごとにリセット
- LocalStorageのtimestampで判定

### 12.9.5 フィードバック画面の表示パターン

| パターン | スコア | 現在レベル | 表示内容 |
|---------|--------|-----------|---------|
| A | 70点以上 | N5〜N2 | 「素晴らしい！N○にチャレンジしましょう！」+ レベルアップボタン |
| B | 70点以上 | N1 | 「最高レベル（N1）で優秀な成績です！」+ 継続ボタン |
| C | 31〜69点 | N5〜N1 | 「もう少し練習しましょう。」+ 再挑戦ボタン + 上位チャレンジボタン |
| D | 30点以下 | N4〜N1 | 「基礎から練習しましょう。」+ レベルダウンボタン |
| E | 30点以下 | N5 | 「N5で基礎を固めましょう。」+ 継続ボタン |

### 12.9.6 平均スコア表示

複数回受験時のフィードバック画面に以下を表示：

```
┌─────────────────────────────────┐
│ 最終評価（平均） - N3           │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│ 75点                           │
│ 受験回数: 3回                   │
│ 最高: 82点  最低: 68点          │
└─────────────────────────────────┘
```
