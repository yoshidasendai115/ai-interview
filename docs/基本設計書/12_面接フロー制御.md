# 12. 面接フロー制御

## 12.1 面接セッション全体フロー

![面接フローシーケンス図](../images/設計書_11.1_面接フロー.png)

## 12.2 HeyGen Streaming Avatar統合

### セッション開始シーケンス

```
1. ユーザーが「面接を始める」をタップ
   ↓
2. フロントエンド → バックエンド: POST /api/v1/sessions
   ↓
3. バックエンド: スクリプト取得、セッションレコード作成
   ↓
4. バックエンド → HeyGen API: createStreamingSession()
   ↓
5. HeyGen: WebRTCセッション確立、session_token返却
   ↓
6. バックエンド → フロントエンド: セッション情報 + HeyGenトークン
   ↓
7. フロントエンド: HeyGen SDKでアバター接続
   ↓
8. アバター接続完了 → 面接開始
```

### HeyGen SDK設定

```typescript
import StreamingAvatar, { TaskType } from "@heygen/streaming-avatar";

const avatar = new StreamingAvatar({
  token: sessionToken
});

// アバター開始
await avatar.createStartAvatar({
  avatarName: "wayne_asian_male",
  language: "ja",
  quality: "high"
});

// 質問発話（セリフ通り）
await avatar.speak({
  text: "自己紹介をお願いします。",
  taskType: TaskType.REPEAT
});
```

## 12.3 質問・回答ループ

![質問・回答ループ](../images/設計書_11.3_質問回答ループ.png)

## 12.4 Google Cloud STT統合

### リアルタイム音声認識設定

```typescript
const speechConfig = {
  encoding: "WEBM_OPUS",
  sampleRateHertz: 48000,
  languageCode: "ja-JP",
  enableAutomaticPunctuation: true,
  model: "latest_long",
  useEnhanced: true
};
```

### 音声入力フロー

```
1. マイクボタンタップ → MediaRecorder開始
   ↓
2. 音声データをWebSocketでバックエンドに送信
   ↓
3. バックエンド → Google Cloud STT（Streaming API）
   ↓
4. 中間結果をリアルタイムでフロントエンドに返却
   ↓
5. 最終結果確定 → 回答テキストとして保存
   ↓
6. 5秒間無音検出 → 自動停止
```

## 12.5 セッション完了処理

```
1. 最後の質問回答完了
   ↓
2. フロントエンド → バックエンド: PUT /api/v1/sessions/{id}/complete
   ↓
3. バックエンド: HeyGenセッション終了
   ↓
4. バックエンド: 評価処理（非同期）
   ├─ 4a. 日本語能力評価（GPT-4o）
   │      - 各回答の語彙・文法・内容・敬語を評価
   │      - evaluation_detailsテーブルに保存
   │      - 詳細: 07_評価ロジック
   │
   └─ 4b. 採用適性評価（GPT-4o）
          - セッション全体から適応力・コミュニケーション力・主体性・定着意向・協調性を評価
          - aptitude_evaluationsテーブルに保存
          - 詳細: 13_面接シナリオ設計
   ↓
5. 両評価を統合 → evaluationsテーブルに総合スコアを保存
   ↓
6. mintoku workへ統合結果を送信
   ↓
7. フロントエンド: フィードバック画面へ遷移
```

### 12.5.1 評価処理の詳細

| 評価種別 | 評価対象 | スコア範囲 | 保存先テーブル |
|---------|---------|----------|--------------|
| 日本語能力評価 | 語彙・文法・内容・敬語 | 0-100点 | evaluation_details |
| 採用適性評価 | 適応力・コミュニケーション力・主体性・定着意向・協調性 | 1-5点 | aptitude_evaluations |
| 統合スコア | 上記2つの加重平均 | 0-100点 | evaluations.total_score |

### 12.5.2 統合スコア計算式

```
統合スコア = (日本語能力スコア × 0.4) + (採用適性スコア × 20 × 0.6)
```

## 12.6 エラーハンドリング

| エラー種別 | 検出方法 | 対応処理 |
|-----------|---------|---------|
| HeyGen接続失敗 | WebRTC接続エラー | 再接続試行（最大3回）→ テキストモードにフォールバック |
| HeyGen発話エラー | speak() Promise reject | 質問テキストを画面表示で代替 |
| STT接続失敗 | WebSocketエラー | テキスト入力フォームを表示 |
| STT認識失敗 | 空の認識結果 | 再録音を促すメッセージ表示 |
| ネットワーク切断 | navigator.onLine監視 | 再接続待ち画面表示、自動復帰試行 |
| セッションタイムアウト | 30分経過 | セッション中断、途中結果を保存 |

## 12.7 状態管理

```typescript
type SessionState =
  | "initializing"    // HeyGen接続中
  | "ready"           // 接続完了、開始待ち
  | "avatar_speaking" // アバター発話中
  | "listening"       // ユーザー回答待ち
  | "processing"      // 回答処理中
  | "completed"       // セッション完了
  | "error";          // エラー状態

interface SessionContext {
  state: SessionState;
  currentQuestion: number;
  totalQuestions: number;
  answers: Answer[];
  heygenSessionId: string | null;
  sttConnection: WebSocket | null;
}
```
